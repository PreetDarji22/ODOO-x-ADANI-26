{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold">Maintenance Board</h3>
    <a href="/requests/add" class="btn btn-primary"><i class="fa-solid fa-wrench"></i> New Request</a>
</div>

<div class="row g-4">
    
    <div class="col-md-3">
        <h6 class="fw-bold text-uppercase text-secondary mb-3"><i class="fa-regular fa-circle"></i> New</h6>
        <div id="col-New" class="kanban-col" data-stage="New">
            {% for req in requests if req.stage == 'New' %}
                {% include 'requests/_card.html' %}
            {% endfor %}
        </div>
    </div>

    <div class="col-md-3">
        <h6 class="fw-bold text-uppercase text-primary mb-3"><i class="fa-solid fa-spinner"></i> In Progress</h6>
        <div id="col-Progress" class="kanban-col" data-stage="In Progress">
            {% for req in requests if req.stage == 'In Progress' %}
                {% include 'requests/_card.html' %}
            {% endfor %}
        </div>
    </div>

    <div class="col-md-3">
        <h6 class="fw-bold text-uppercase text-success mb-3"><i class="fa-solid fa-check-circle"></i> Repaired</h6>
        <div id="col-Repaired" class="kanban-col" data-stage="Repaired">
            {% for req in requests if req.stage == 'Repaired' %}
                {% include 'requests/_card.html' %}
            {% endfor %}
        </div>
    </div>

    <div class="col-md-3">
        <h6 class="fw-bold text-uppercase text-danger mb-3"><i class="fa-solid fa-trash"></i> Scrap</h6>
        <div id="col-Scrap" class="kanban-col" data-stage="Scrap">
            {% for req in requests if req.stage == 'Scrap' %}
                {% include 'requests/_card.html' %}
            {% endfor %}
        </div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
    // Activate Drag & Drop on all 4 columns
    const columns = document.querySelectorAll('.kanban-col');
    
    columns.forEach(col => {
        new Sortable(col, {
            group: 'kanban', // Allows dragging between columns
            animation: 150,
            ghostClass: 'bg-light', // Class applied to the placeholder while dragging
            onEnd: function (evt) {
                const itemEl = evt.item;  // The card being dragged
                const newStage = evt.to.dataset.stage; // The stage of the column dropped into
                const reqId = itemEl.dataset.id; // The ID of the request

                // Send change to backend
                fetch('/requests/api/update_stage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ req_id: reqId, new_stage: newStage })
                }).then(response => {
                    console.log("Stage updated to:", newStage);
                    // Reload page if dragged to Scrap to see equipment status update (optional)
                    if(newStage === 'Scrap') location.reload();
                });
            }
        });
    });
</script>

<style>
    /* Styling for the drop zones */
    .kanban-col {
        background: #f8f9fa;
        min-height: 500px;
        padding: 10px;
        border-radius: 8px;
        border: 2px dashed #e9ecef;
    }
    .kanban-card {
        cursor: grab;
    }
    .kanban-card:active {
        cursor: grabbing;
    }
</style>
{% endblock %}